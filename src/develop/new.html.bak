<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LightBot 3D - Complete Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
        }

        #gameCanvas {
            flex: 1;
            display: block;
        }

        #ui-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: 350px;
            height: 100vh;
            background: rgba(26, 26, 26, 0.95);
            border-left: 2px solid #4CAF50;
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
        }

        #ui-panel h2 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 18px;
        }

        #ui-panel h3 {
            color: #66BB6A;
            margin: 10px 0 5px 0;
            font-size: 14px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        button {
            margin: 5px 0;
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }

        .controls button {
            flex: 1;
            min-width: 100px;
        }

        #instructions-palette {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin: 10px 0;
        }

        #instructions-palette button {
            padding: 8px;
            font-size: 12px;
            background: #2196F3;
        }

        #instructions-palette button:hover {
            background: #1976D2;
        }

        .program-area {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #555;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            min-height: 80px;
        }

        .program-area.focused {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .program-area h4 {
            color: #4CAF50;
            font-size: 12px;
            margin-bottom: 5px;
            cursor: pointer;
            user-select: none;
        }

        .program-area h4:hover {
            color: #66BB6A;
            text-decoration: underline;
        }

        .program-area.focused h4 {
            font-weight: bold;
            color: #66BB6A;
        }

        .instruction-list {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            min-height: 40px;
        }

        .instruction-item {
            background: #2196F3;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .instruction-item:hover {
            background: #F44336;
        }

        #level-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin: 10px 0;
        }

        .level-button {
            padding: 15px 5px;
            font-size: 12px;
            background: #666;
        }

        .level-button.completed {
            background: #4CAF50;
        }

        .level-button.gold {
            background: #FFD700;
            color: #000;
        }

        .level-button.silver {
            background: #C0C0C0;
            color: #000;
        }

        .level-button.bronze {
            background: #CD7F32;
            color: #fff;
        }

        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            z-index: 50;
        }

        #info-panel h2 {
            color: #4CAF50;
            margin-bottom: 5px;
        }

        #camera-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 50;
        }

        #camera-controls button {
            margin: 2px;
            padding: 8px 12px;
            font-size: 12px;
            width: auto;
        }

        .dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2c2c2c;
            border: 3px solid #4CAF50;
            border-radius: 10px;
            padding: 30px;
            z-index: 200;
            min-width: 300px;
            text-align: center;
            display: none;
        }

        .dialog.active {
            display: block;
        }

        .dialog h2 {
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .dialog .medal {
            font-size: 48px;
            margin: 20px 0;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 199;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        #execution-status {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #FFC107;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }

        #execution-status.active {
            display: block;
        }

        #toggle-ui-mobile {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        #toggle-ui-mobile:active {
            background: #45a049;
        }

        #ui-panel.collapsed .screen {
            display: none !important;
        }

        #ui-panel.collapsed #toggle-ui-mobile {
            display: block !important;
        }

        #ui-panel.collapsed {
            max-height: 50px;
            min-height: 50px;
            padding: 5px;
        }

        #ui-panel.collapsed ~ #gameCanvas {
            height: calc(100vh - 60px) !important;
        }

        /* Map Editor Styles */
        #map-grid {
            display: inline-block;
            border: 2px solid #4CAF50;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px;
            border-radius: 5px;
        }

        .map-row {
            display: flex;
            gap: 2px;
        }

        .map-cell {
            width: 40px;
            height: 40px;
            border: 1px solid #666;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s;
            position: relative;
        }

        .map-cell:hover {
            border-color: #4CAF50;
            transform: scale(1.1);
            z-index: 10;
        }

        .map-cell.selected {
            border: 3px solid #FFD700;
            box-shadow: 0 0 10px #FFD700;
        }

        .map-cell.bot-position {
            border: 3px solid #00FF00;
            box-shadow: 0 0 10px #00FF00;
        }

        .map-cell .height {
            font-size: 14px;
            font-weight: bold;
        }

        .map-cell .type {
            font-size: 8px;
        }

        .height-btn, .type-btn {
            padding: 8px 12px;
            min-width: 50px;
            font-size: 13px;
        }

        .height-btn.active {
            background: #FFD700 !important;
            color: #000;
            font-weight: bold;
        }

        .type-btn {
            flex: 1;
        }

        .type-btn.active {
            border: 3px solid #FFD700;
            box-shadow: 0 0 10px #FFD700;
        }

        /* Mobile Responsive Layout */
        @media (max-width: 768px) {
            body {
                overflow-y: auto;
                overflow-x: hidden;
            }

            #toggle-ui-mobile {
                display: block !important;
            }

            #container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                overflow: visible;
            }

            #ui-panel {
                position: relative;
                width: 100%;
                max-width: 100%;
                height: auto;
                max-height: none;
                border-left: none;
                border-bottom: 3px solid #4CAF50;
                order: 1;
                overflow-y: visible;
                padding: 15px;
            }

            #gameCanvas {
                order: 2;
                min-height: 400px;
                height: 50vh;
                width: 100% !important;
                display: block;
            }

            #info-panel {
                top: 5px;
                left: 5px;
                font-size: 11px;
                padding: 8px;
            }

            #info-panel h2 {
                font-size: 14px;
                margin-bottom: 3px;
            }

            #camera-controls {
                bottom: 5px;
                right: 5px;
                left: auto;
                display: flex;
                gap: 5px;
            }

            #camera-controls button {
                padding: 6px 10px;
                font-size: 10px;
            }

            button {
                padding: 8px 12px;
                font-size: 13px;
            }

            .controls button {
                min-width: 80px;
            }

            #instructions-palette {
                grid-template-columns: repeat(3, 1fr);
            }

            #level-list {
                grid-template-columns: repeat(3, 1fr);
            }

            .program-area {
                min-height: 60px;
                padding: 8px;
            }

            .program-area h4 {
                font-size: 11px;
            }

            .instruction-item {
                padding: 3px 6px;
                font-size: 10px;
            }

            #ui-panel h2 {
                font-size: 16px;
                margin-bottom: 10px;
            }

            #ui-panel h3 {
                font-size: 13px;
                margin: 8px 0 4px 0;
            }
        }

        @media (max-width: 480px) {
            #ui-panel {
                padding: 15px;
                max-height: 65vh;
            }

            #gameCanvas {
                height: 300px;
            }

            /* Map editor mobile adjustments */
            .map-cell {
                width: 35px;
                height: 35px;
                font-size: 12px;
            }

            #map-grid {
                overflow-x: auto;
                max-width: 100%;
            }

            .height-btn, .type-btn {
                padding: 6px 8px;
                min-width: 40px;
                font-size: 11px;
            }

            #instructions-palette {
                grid-template-columns: repeat(2, 1fr);
            }

            #level-list {
                grid-template-columns: repeat(2, 1fr);
            }

            .program-area {
                margin: 8px 0;
            }

            button {
                padding: 6px 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="gameCanvas"></canvas>

        <div id="info-panel">
            <h2 id="level-title">LightBot 3D</h2>
            <p id="level-info"></p>
        </div>

        <div id="camera-controls">
            <button onclick="game.resetCamera()">Reset Camera</button>
            <button onclick="game.toggleWireframe()">Wireframe</button>
        </div>

        <div id="ui-panel">
            <div style="display: flex; gap: 5px;">
                <button id="toggle-ui-mobile" style="display: none; flex: 1;">‚ñº Show/Hide Controls</button>
                <button id="toggle-map-editor" style="display: none; flex: 1; background: #FF9800;">üó∫Ô∏è Map Editor</button>
            </div>

            <!-- Map Editor -->
            <div id="map-editor-screen" class="screen" style="display: none;">
                <h2>Map Editor</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button onclick="game.closeMapEditor()" style="flex: 1; background: #4CAF50;">‚úì Done Editing</button>
                    <button onclick="game.resetMapToOriginal()" style="flex: 1; background: #F44336;">‚Ü∫ Reset Map</button>
                </div>

                <div id="map-grid" style="margin: 15px 0; overflow: auto;"></div>

                <div id="block-editor" style="display: none; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin-top: 10px;">
                    <h3>Editing Block (<span id="edit-coords"></span>)</h3>

                    <div style="margin: 10px 0;">
                        <label style="display: block; margin-bottom: 5px;">Height:</label>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button onclick="game.setBlockHeight(0)" class="height-btn">0</button>
                            <button onclick="game.setBlockHeight(1)" class="height-btn">1</button>
                            <button onclick="game.setBlockHeight(2)" class="height-btn">2</button>
                            <button onclick="game.setBlockHeight(3)" class="height-btn">3</button>
                            <button onclick="game.setBlockHeight(4)" class="height-btn">4</button>
                            <button onclick="game.setBlockHeight(5)" class="height-btn">5</button>
                            <button onclick="game.setBlockHeight(6)" class="height-btn">6</button>
                        </div>
                    </div>

                    <div style="margin: 10px 0;">
                        <label style="display: block; margin-bottom: 5px;">Type:</label>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button onclick="game.setBlockType('b')" class="type-btn" style="background: #999;">üì¶ Normal</button>
                            <button onclick="game.setBlockType('l')" class="type-btn" style="background: #0468fb;">üí° Light</button>
                            <button onclick="game.setBlockType('e')" class="type-btn" style="background: #dc84bf;">üéöÔ∏è Elevator</button>
                        </div>
                    </div>

                    <button onclick="game.clearBlockSelection()" style="width: 100%; margin-top: 10px; background: #666;">Clear Selection</button>
                </div>
            </div>

            <!-- Welcome Screen -->
            <div id="welcome-screen" class="screen active">
                <h2>ü§ñ LightBot 3D</h2>
                <p style="margin: 15px 0; line-height: 1.6;">
                    Program the robot to light up all the blue tiles!
                </p>
                <button onclick="game.showScreen('level-select')">Start Game</button>
                <button onclick="game.showScreen('help')">How to Play</button>
            </div>

            <!-- Help Screen -->
            <div id="help-screen" class="screen">
                <h2>How to Play</h2>
                <div style="text-align: left; line-height: 1.6; font-size: 13px; margin: 15px 0;">
                    <h3>Goal</h3>
                    <p>Light up all blue tiles by programming the robot.</p>

                    <h3>Instructions</h3>
                    <p><strong>Walk:</strong> Move forward (same height only)<br>
                    <strong>Jump:</strong> Jump up 1 level or down any levels<br>
                    <strong>Light:</strong> Toggle light on/off<br>
                    <strong>Turn Left/Right:</strong> Rotate 90¬∞<br>
                    <strong>Proc1/Proc2:</strong> Call procedure</p>

                    <h3>Controls</h3>
                    <p>‚Ä¢ Click instructions to add to program<br>
                    ‚Ä¢ Click instruction in program to remove<br>
                    ‚Ä¢ Click program area name to switch focus<br>
                    ‚Ä¢ Use Run/Fast buttons to execute</p>

                    <h3>Medals</h3>
                    <p>ü•á Gold | ü•à Silver | ü•â Bronze<br>
                    Earned by using fewer instructions!</p>
                </div>
                <button onclick="game.showScreen('welcome')">Back</button>
            </div>

            <!-- Level Select Screen -->
            <div id="level-select-screen" class="screen">
                <h2>Select Level</h2>
                <div id="level-list"></div>
                <button onclick="game.showScreen('welcome')">Back to Menu</button>
            </div>

            <!-- Game Screen -->
            <div id="game-screen" class="screen">
                <h2>Programming</h2>

                <div id="execution-status">
                    <strong>‚öôÔ∏è Executing...</strong>
                </div>

                <div class="controls">
                    <button onclick="game.runProgram()" id="run-button">‚ñ∂Ô∏è Run</button>
                    <button onclick="game.runProgram(true)" id="fast-button">‚è© Fast</button>
                    <button onclick="game.stopExecution()" id="stop-button" style="display:none; background:#F44336">‚èπÔ∏è Stop</button>
                </div>

                <div class="controls">
                    <button onclick="game.clearPrograms()">üóëÔ∏è Clear All</button>
                    <button onclick="game.showScreen('level-select')">üìã Levels</button>
                </div>

                <h3>Instructions</h3>
                <div id="instructions-palette">
                    <button onclick="game.addInstruction('walk')">‚¨ÜÔ∏è Walk</button>
                    <button onclick="game.addInstruction('jump')">‚§¥Ô∏è Jump</button>
                    <button onclick="game.addInstruction('turnLeft')">‚Ü™Ô∏è Left</button>
                    <button onclick="game.addInstruction('turnRight')">‚Ü©Ô∏è Right</button>
                    <button onclick="game.addInstruction('light')">üí° Light</button>
                    <button onclick="game.addInstruction('proc1')">P1</button>
                    <button onclick="game.addInstruction('proc2')">P2</button>
                </div>

                <h3>Programs</h3>
                <div class="program-area focused" id="main-program">
                    <h4 onclick="game.focusProgram('main')">Main Program</h4>
                    <ul class="instruction-list" id="main-list"></ul>
                </div>

                <div class="program-area" id="proc1-program">
                    <h4 onclick="game.focusProgram('proc1')">Procedure 1</h4>
                    <ul class="instruction-list" id="proc1-list"></ul>
                </div>

                <div class="program-area" id="proc2-program">
                    <h4 onclick="game.focusProgram('proc2')">Procedure 2</h4>
                    <ul class="instruction-list" id="proc2-list"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Dialogs -->
    <div class="overlay" id="dialog-overlay" onclick="game.closeDialog()"></div>
    <div class="dialog" id="complete-dialog">
        <h2>üéâ Level Complete!</h2>
        <div class="medal" id="medal-display"></div>
        <p id="complete-message"></p>
        <button onclick="game.nextLevel()">Next Level</button>
        <button onclick="game.showScreen('level-select')">Level Select</button>
    </div>

    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- Shared map data -->
    <script type="text/javascript" src="js/lightbot.maps.data.js"></script>

    <script>
    // ============================================================================
    // LIGHTBOT GAME - Complete Implementation
    // ============================================================================

    const game = {
        // Three.js components
        scene: null,
        camera: null,
        renderer: null,
        controls: null,
        boxes: [],
        botMesh: null,
        tileHighlight: null,

        // Game state
        currentLevel: 0,
        focusedProgram: 'main',
        isExecuting: false,
        executionSpeed: 500, // ms between instructions
        wireframeMode: false,
        mapEditorMode: false,
        selectedBlock: null,
        originalLevelData: null,

        // Bot state
        bot: {
            position: { x: 0, y: 0 },
            direction: 0, // 0=SE, 1=NE, 2=NW, 3=SW
            startPosition: { x: 0, y: 0 },
            startDirection: 0,
            currentAnimation: 'stand'
        },

        // Programs
        programs: {
            main: [],
            proc1: [],
            proc2: []
        },

        // Level data
        levelData: null,

        // Colors
        colors: {
            box: { top: 0xc9d3d9, front: 0xadb8bd, side: 0xe5f0f5 },
            lightBox: { on: 0xFFE545, off: 0x0468fb },
            elevator: 0xdc84bf,
            stroke: 0x485256,
            bot: 0xff6b35
        },

        // Instruction definitions
        instructionDefs: {
            walk: { name: 'walk', display: '‚¨ÜÔ∏è Walk', execute: 'walk' },
            jump: { name: 'jump', display: '‚§¥Ô∏è Jump', execute: 'jump' },
            light: { name: 'light', display: 'üí° Light', execute: 'light' },
            turnLeft: { name: 'turnLeft', display: '‚Ü™Ô∏è Left', execute: 'turnLeft' },
            turnRight: { name: 'turnRight', display: '‚Ü©Ô∏è Right', execute: 'turnRight' },
            proc1: { name: 'proc1', display: 'P1', execute: 'proc1' },
            proc2: { name: 'proc2', display: 'P2', execute: 'proc2' }
        },

        // All 24 levels
        levels: window.lightBotMapsData || [
  {"direction": 0, "position": {"x": 4, "y": 5}, "map": [[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}]], "medals": {"gold": 3, "silver": 4, "bronze": 5}},
  {"direction": 0, "position": {"x": 2, "y": 5}, "map": [[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}]], "medals": {"gold": 5, "silver": 7, "bronze": 11}},
  {"direction": 0, "position": {"x": 4, "y": 6}, "map": [[{"h":4, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":4, "t":"b"}],[{"h":3, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":3, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":4, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":3, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":3, "t":"b"}],[{"h":4, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":4, "t":"b"}]], "medals": {"gold": 6, "silver": 8, "bronze": 11}},
  {"direction": 0, "position": {"x": 4, "y": 7}, "map": [[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":2, "t":"b"}, {"h":2, "t":"b"},{"h":2, "t":"b"},{"h":2, "t":"b"},{"h":2, "t":"b"}, {"h":2, "t":"b"},{"h":2, "t":"b"},{"h":2, "t":"b"},{"h":2, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}]], "medals": {"gold": 4, "silver": 5, "bronze": 6}},
  {"direction": 1, "position": {"x": 1, "y": 5}, "map": [[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"},{"h":3, "t":"b"}, {"h":3, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":3, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":3, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":3, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":3, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":3, "t":"l"},{"h":1, "t":"b"}]], "medals": {"gold": 7, "silver": 8, "bronze": 11}},
  {"direction": 0, "position": {"x": 2, "y": 4}, "map": [[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":6, "t":"l"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":5, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":3, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":4, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":3, "t":"b"},{"h":3, "t":"b"},{"h":3, "t":"b"}, {"h":3, "t":"b"},{"h":3, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}]], "medals": {"gold": 7, "silver": 10, "bronze": 13}},
  {"direction": 1, "position": {"x": 1, "y": 5}, "map": [[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"},{"h":3, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":4, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":5, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":3, "t":"l"},{"h":3, "t":"b"},{"h":3, "t":"b"},{"h":3, "t":"b"}, {"h":3, "t":"b"},{"h":3, "t":"b"},{"h":3, "t":"l"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}]], "medals": {"gold": 10, "silver": 17, "bronze": 22}},
  {"direction": 1, "position": {"x": 1, "y": 3}, "map": [[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":3, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":3, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":3, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":5, "t":"b"}, {"h":5, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"},{"h":3, "t":"b"}, {"h":4, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":4, "t":"b"}, {"h":5, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":3, "t":"b"}, {"h":3, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":3, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"b"}]], "medals": {"gold": 16, "silver": 25, "bronze": 26}},
  {"direction": 0, "position": {"x": 4, "y": 7}, "map": [[{"h":3, "t":"b"},{"h":3, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":2, "t":"b"},{"h":3, "t":"b"},{"h":3, "t":"b"}],[{"h":3, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":3, "t":"b"}],[{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}]], "medals": {"gold": 3, "silver": 14, "bronze": 15}},
  {"direction": 0, "position": {"x": 4, "y": 7}, "map": [[{"h":3, "t":"b"},{"h":3, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":2, "t":"b"},{"h":3, "t":"b"},{"h":3, "t":"b"}],[{"h":3, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":3, "t":"b"}],[{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":3, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":4, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":3, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":4, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}]], "medals": {"gold": 3, "silver": 7, "bronze": 13}},
  {"direction": 0, "position": {"x": 4, "y": 7}, "map": [[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}]], "medals": {"gold": 7, "silver": 9, "bronze": 11}},
  {"direction": 0, "position": {"x": 1, "y": 7}, "map": [[{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":2, "t":"l"},{"h":1, "t":"l"},{"h":2, "t":"l"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":3, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":1, "t":"l"},{"h":2, "t":"l"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":3, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":1, "t":"l"},{"h":2, "t":"l"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":3, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":1, "t":"l"},{"h":2, "t":"l"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":3, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":1, "t":"l"},{"h":2, "t":"l"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":3, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":1, "t":"l"},{"h":2, "t":"l"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":3, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":1, "t":"l"},{"h":2, "t":"l"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":3, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":1, "t":"l"},{"h":2, "t":"l"},{"h":1, "t":"l"}, {"h":2, "t":"l"},{"h":3, "t":"b"}]], "medals": {"gold": 13, "silver": 33, "bronze": 104}},
  {"direction": 0, "position": {"x": 1, "y": 6}, "map": [[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":2, "t":"b"},{"h":3, "t":"l"},{"h":2, "t":"l"}, {"h":2, "t":"l"},{"h":3, "t":"l"},{"h":2, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"l"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":2, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"l"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":2, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":2, "t":"b"},{"h":3, "t":"l"},{"h":2, "t":"l"}, {"h":2, "t":"l"},{"h":3, "t":"l"},{"h":2, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}]], "medals": {"gold": 11, "silver": 29, "bronze": 29}},
  {"direction": 1, "position": {"x": 1, "y": 5}, "map": [[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"},{"h":2, "t":"l"}, {"h":2, "t":"b"},{"h":2, "t":"l"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":2, "t":"l"},{"h":2, "t":"b"},{"h":2, "t":"l"}, {"h":2, "t":"b"},{"h":2, "t":"l"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":2, "t":"l"},{"h":2, "t":"b"},{"h":2, "t":"l"}, {"h":2, "t":"b"},{"h":2, "t":"l"},{"h":1, "t":"b"}],[{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}]], "medals": {"gold": 7, "silver": 24, "bronze": 28}},
  {"direction": 1, "position": {"x": 1, "y": 4}, "map": [[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":5, "t":"l"},{"h":4, "t":"l"}, {"h":3, "t":"l"},{"h":2, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":4, "t":"l"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":3, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":3, "t":"l"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":4, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"l"},{"h":3, "t":"l"}, {"h":4, "t":"l"},{"h":5, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":3, "t":"l"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":4, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":4, "t":"l"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":3, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":5, "t":"l"},{"h":4, "t":"l"}, {"h":3, "t":"l"},{"h":2, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}]], "medals": {"gold": 13, "silver": 16, "bronze": 26}},
  {"direction": 1, "position": {"x": 1, "y": 3}, "map": [[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":2, "t":"l"},{"h":2, "t":"b"},{"h":2, "t":"b"},{"h":2, "t":"b"}, {"h":2, "t":"l"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":2, "t":"b"},{"h":3, "t":"l"},{"h":3, "t":"b"},{"h":3, "t":"l"}, {"h":2, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":2, "t":"b"},{"h":3, "t":"b"},{"h":4, "t":"l"},{"h":3, "t":"b"}, {"h":2, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":2, "t":"b"},{"h":3, "t":"l"},{"h":3, "t":"b"},{"h":3, "t":"l"}, {"h":2, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":2, "t":"l"},{"h":2, "t":"b"},{"h":2, "t":"b"},{"h":2, "t":"b"}, {"h":2, "t":"l"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"}]], "medals": {"gold": 10, "silver": 32, "bronze": 43}},
  {"direction": 0, "position": {"x": 0, "y": 6}, "map": [[{"h":1, "t":"b"}, {"h":3, "t":"l"},{"h":3, "t":"l"}],[{"h":1, "t":"b"}, {"h":3, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":3, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":5, "t":"b"},{"h":5, "t":"b"}],[{"h":2, "t":"b"}, {"h":3, "t":"b"},{"h":4, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":3, "t":"b"}],[{"h":4, "t":"l"}, {"h":3, "t":"b"},{"h":3, "t":"b"}]], "medals": {"gold": 18, "silver": 20, "bronze": 22}},
  {"direction": 3, "position": {"x": 2, "y": 0}, "map": [[{"h":1, "t":"b"}, {"h":2, "t":"l"},{"h":2, "t":"b"},{"h":2, "t":"l"}, {"h":1, "t":"b"}],[{"h":2, "t":"l"}, {"h":2, "t":"l"},{"h":1, "t":"b"},{"h":2, "t":"l"}, {"h":2, "t":"l"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":2, "t":"b"}],[{"h":2, "t":"l"}, {"h":2, "t":"l"},{"h":1, "t":"b"},{"h":2, "t":"l"}, {"h":2, "t":"l"}],[{"h":1, "t":"b"}, {"h":2, "t":"l"},{"h":2, "t":"b"},{"h":2, "t":"l"}, {"h":1, "t":"b"}]], "medals": {"gold": 9, "silver": 10, "bronze": 16}},
  {"direction": 2, "position": {"x": 0, "y": 2}, "map": [[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"b"},{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":2, "t":"l"},{"h":2, "t":"b"},{"h":1, "t":"l"},{"h":2, "t":"b"}, {"h":1, "t":"l"},{"h":1, "t":"b"},{"h":2, "t":"l"},{"h":1, "t":"b"}],[{"h":1, "t":"l"}, {"h":1, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":2, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"l"}],[{"h":1, "t":"b"}, {"h":1, "t":"l"},{"h":1, "t":"b"},{"h":2, "t":"b"},{"h":2, "t":"b"}, {"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"b"}],[{"h":2, "t":"b"}, {"h":2, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"}, {"h":2, "t":"b"},{"h":1, "t":"b"},{"h":2, "t":"b"},{"h":2, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"l"},{"h":1, "t":"b"},{"h":2, "t":"b"},{"h":2, "t":"b"}, {"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"b"}],[{"h":1, "t":"l"}, {"h":2, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":2, "t":"b"},{"h":1, "t":"b"},{"h":1, "t":"l"}],[{"h":1, "t":"b"}, {"h":2, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"l"},{"h":2, "t":"b"}, {"h":1, "t":"l"},{"h":2, "t":"b"},{"h":2, "t":"l"},{"h":1, "t":"b"}],[{"h":1, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"b"},{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":1, "t":"l"},{"h":1, "t":"b"},{"h":1, "t":"b"}]], "medals": {"gold": 9, "silver": 11, "bronze": 13}},
  {"direction": 2, "position": {"x": 2, "y": 0}, "map": [[{"h":4, "t":"b"}, {"h":4, "t":"b"},{"h":3, "t":"l"},{"h":3, "t":"b"},{"h":3, "t":"b"}, {"h":1, "t":"e"},{"h":4, "t":"b"},{"h":4, "t":"b"}],[{"h":4, "t":"b"}, {"h":3, "t":"l"},{"h":3, "t":"b"},{"h":4, "t":"l"},{"h":4, "t":"l"}, {"h":3, "t":"b"},{"h":3, "t":"l"},{"h":4, "t":"b"}],[{"h":1, "t":"e"}, {"h":3, "t":"b"},{"h":3, "t":"b"},{"h":4, "t":"l"},{"h":4, "t":"l"}, {"h":3, "t":"b"},{"h":3, "t":"b"},{"h":3, "t":"l"}],[{"h":3, "t":"b"}, {"h":4, "t":"l"},{"h":4, "t":"l"},{"h":4, "t":"b"},{"h":4, "t":"b"}, {"h":4, "t":"l"},{"h":4, "t":"l"},{"h":3, "t":"b"}],[{"h":3, "t":"b"}, {"h":4, "t":"l"},{"h":4, "t":"l"},{"h":4, "t":"b"},{"h":4, "t":"b"}, {"h":4, "t":"l"},{"h":4, "t":"l"},{"h":3, "t":"b"}],[{"h":3, "t":"l"}, {"h":3, "t":"b"},{"h":3, "t":"b"},{"h":4, "t":"l"},{"h":4, "t":"l"}, {"h":3, "t":"b"},{"h":3, "t":"b"},{"h":1, "t":"e"}],[{"h":4, "t":"b"}, {"h":3, "t":"l"},{"h":3, "t":"b"},{"h":4, "t":"l"},{"h":4, "t":"l"}, {"h":3, "t":"b"},{"h":3, "t":"l"},{"h":4, "t":"b"}],[{"h":4, "t":"b"}, {"h":4, "t":"b"},{"h":1, "t":"e"},{"h":3, "t":"b"},{"h":3, "t":"b"}, {"h":3, "t":"l"},{"h":4, "t":"b"},{"h":4, "t":"b"}]], "medals": {"gold": 9, "silver": 11, "bronze": 13}},
  {"direction": 1, "position": {"x": 0, "y": 5}, "map": [[{"h": 1, "t": "b"}, {"h": 1, "t": "b"}, {"h": 1, "t": "l"}, {"h": 1, "t": "l"}, {"h": 2, "t": "l"}, {"h": 1, "t": "b"}, {"h": 1, "t": "l"}, {"h": 1, "t": "b"}, {"h": 1, "t": "b"}],[{"h": 1, "t": "b"}, {"h": 2, "t": "l"}, {"h": 2, "t": "l"}, {"h": 1, "t": "l"}, {"h": 2, "t": "l"}, {"h": 1, "t": "l"}, {"h": 1, "t": "l"}, {"h": 2, "t": "l"}, {"h": 1, "t": "b"}],[{"h": 1, "t": "l"}, {"h": 1, "t": "l"}, {"h": 2, "t": "l"}, {"h": 1, "t": "l"}, {"h": 1, "t": "b"}, {"h": 1, "t": "l"}, {"h": 2, "t": "l"}, {"h": 2, "t": "l"}, {"h": 1, "t": "l"}],[{"h": 1, "t": "b"}, {"h": 1, "t": "l"}, {"h": 1, "t": "l"}, {"h": 2, "t": "l"}, {"h": 2, "t": "b"}, {"h": 2, "t": "l"}, {"h": 1, "t": "l"}, {"h": 1, "t": "l"}, {"h": 1, "t": "l"}],[{"h": 2, "t": "l"}, {"h": 2, "t": "l"}, {"h": 1, "t": "b"}, {"h": 2, "t": "b"}, {"h": 1, "t": "b"}, {"h": 2, "t": "b"}, {"h": 1, "t": "b"}, {"h": 2, "t": "l"}, {"h": 2, "t": "l"}],[{"h": 1, "t": "l"}, {"h": 1, "t": "l"}, {"h": 1, "t": "l"}, {"h": 2, "t": "l"}, {"h": 2, "t": "b"}, {"h": 2, "t": "l"}, {"h": 1, "t": "l"}, {"h": 1, "t": "l"}, {"h": 1, "t": "b"}],[{"h": 1, "t": "l"}, {"h": 2, "t": "l"}, {"h": 2, "t": "l"}, {"h": 1, "t": "l"}, {"h": 1, "t": "b"}, {"h": 1, "t": "l"}, {"h": 2, "t": "l"}, {"h": 1, "t": "l"}, {"h": 1, "t": "l"}],[{"h": 1, "t": "b"}, {"h": 2, "t": "l"}, {"h": 1, "t": "l"}, {"h": 1, "t": "l"}, {"h": 2, "t": "l"}, {"h": 1, "t": "l"}, {"h": 2, "t": "l"}, {"h": 2, "t": "l"}, {"h": 1, "t": "b"}],[{"h": 1, "t": "b"}, {"h": 1, "t": "b"}, {"h": 1, "t": "l"}, {"h": 1, "t": "b"}, {"h": 2, "t": "l"}, {"h": 1, "t": "l"}, {"h": 1, "t": "l"}, {"h": 1, "t": "b"}, {"h": 1, "t": "b"}]], "medals": {"gold": 11, "silver": 13, "bronze": 15}},
  {"direction": 3, "position": {"x": 0, "y": 0}, "map": [[{"h":4, "t":"e"}, {"h":4, "t":"e"},{"h":2, "t":"b"},{"h":2, "t":"l"}, {"h":1, "t":"b"}],[{"h":2, "t":"l"}, {"h":4, "t":"e"},{"h":3, "t":"e"},{"h":2, "t":"l"}, {"h":2, "t":"l"}],[{"h":2, "t":"b"}, {"h":1, "t":"b"},{"h":3, "t":"e"},{"h":3, "t":"e"}, {"h":2, "t":"b"}],[{"h":2, "t":"l"}, {"h":2, "t":"l"},{"h":1, "t":"b"},{"h":2, "t":"e"}, {"h":1, "t":"e"}],[{"h":5, "t":"e"}, {"h":2, "t":"l"},{"h":2, "t":"b"},{"h":2, "t":"l"}, {"h":2, "t":"e"}]], "medals": {"gold": 9, "silver": 10, "bronze": 16}},
  {"direction": 2, "position": {"x": 2, "y": 0}, "map": [[{"h":4, "t":"b"}, {"h":4, "t":"b"},{"h":3, "t":"b"},{"h":3, "t":"b"},{"h":3, "t":"b"}, {"h":1, "t":"e"},{"h":4, "t":"b"},{"h":4, "t":"b"}],[{"h":4, "t":"b"}, {"h":3, "t":"e"},{"h":3, "t":"b"},{"h":4, "t":"l"},{"h":4, "t":"b"}, {"h":3, "t":"b"},{"h":3, "t":"e"},{"h":4, "t":"b"}],[{"h":1, "t":"e"}, {"h":3, "t":"b"},{"h":3, "t":"b"},{"h":4, "t":"l"},{"h":4, "t":"l"}, {"h":3, "t":"b"},{"h":3, "t":"b"},{"h":3, "t":"b"}],[{"h":3, "t":"b"}, {"h":4, "t":"b"},{"h":4, "t":"l"},{"h":4, "t":"b"},{"h":4, "t":"b"}, {"h":4, "t":"l"},{"h":4, "t":"l"},{"h":3, "t":"b"}],[{"h":3, "t":"b"}, {"h":4, "t":"l"},{"h":4, "t":"l"},{"h":4, "t":"b"},{"h":4, "t":"b"}, {"h":4, "t":"l"},{"h":4, "t":"b"},{"h":3, "t":"b"}],[{"h":3, "t":"b"}, {"h":3, "t":"b"},{"h":3, "t":"b"},{"h":4, "t":"l"},{"h":4, "t":"l"}, {"h":3, "t":"b"},{"h":3, "t":"b"},{"h":1, "t":"e"}],[{"h":4, "t":"b"}, {"h":3, "t":"e"},{"h":3, "t":"b"},{"h":4, "t":"b"},{"h":4, "t":"l"}, {"h":3, "t":"b"},{"h":3, "t":"e"},{"h":4, "t":"b"}],[{"h":4, "t":"b"}, {"h":4, "t":"b"},{"h":1, "t":"e"},{"h":3, "t":"b"},{"h":3, "t":"b"}, {"h":3, "t":"b"},{"h":4, "t":"b"},{"h":4, "t":"b"}]], "medals": {"gold": 8, "silver": 9, "bronze": 10}},
  {"direction": 0, "position": {"x": 5, "y": 5}, "map": [[{"h":3, "t":"l"}, {"h":3, "t":"l"},{"h":5, "t":"l"},{"h":5, "t":"l"},{"h":3, "t":"l"}, {"h":3, "t":"l"}],[{"h":0, "t":"e"}, {"h":0, "t":"e"},{"h":0, "t":"e"},{"h":0, "t":"e"},{"h":0, "t":"e"}, {"h":0, "t":"e"}],[{"h":0, "t":"e"}, {"h":0, "t":"e"},{"h":0, "t":"e"},{"h":0, "t":"e"},{"h":0, "t":"e"}, {"h":0, "t":"e"}],[{"h":0, "t":"e"}, {"h":0, "t":"e"},{"h":0, "t":"e"},{"h":0, "t":"e"},{"h":0, "t":"e"}, {"h":0, "t":"e"}],[{"h":0, "t":"e"}, {"h":0, "t":"e"},{"h":0, "t":"e"},{"h":0, "t":"e"},{"h":0, "t":"e"}, {"h":0, "t":"e"}],[{"h":0, "t":"e"}, {"h":0, "t":"e"},{"h":0, "t":"e"},{"h":0, "t":"e"},{"h":0, "t":"e"}, {"h":0, "t":"e"}],[{"h":0, "t":"e"}, {"h":0, "t":"e"},{"h":0, "t":"e"},{"h":0, "t":"e"},{"h":0, "t":"e"}, {"h":0, "t":"e"}]], "medals": {"gold": 8, "silver": 10, "bronze": 12}},
  {"direction": 0, "position": {"x": 5, "y": 5}, "map": [[{"h":3, "t":"l"}, {"h":3, "t":"l"},{"h":5, "t":"l"},{"h":5, "t":"l"},{"h":3, "t":"l"}, {"h":3, "t":"l"}],[{"h":1, "t":"e"}, {"h":0, "t":"e"},{"h":1, "t":"e"},{"h":0, "t":"e"},{"h":1, "t":"e"}, {"h":0, "t":"e"}],[{"h":0, "t":"e"}, {"h":1, "t":"e"},{"h":0, "t":"e"},{"h":1, "t":"e"},{"h":0, "t":"e"}, {"h":1, "t":"e"}],[{"h":1, "t":"e"}, {"h":0, "t":"e"},{"h":1, "t":"e"},{"h":0, "t":"e"},{"h":1, "t":"e"}, {"h":0, "t":"e"}],[{"h":0, "t":"e"}, {"h":1, "t":"e"},{"h":0, "t":"e"},{"h":1, "t":"e"},{"h":0, "t":"e"}, {"h":1, "t":"e"}],[{"h":1, "t":"e"}, {"h":0, "t":"e"},{"h":1, "t":"e"},{"h":0, "t":"e"},{"h":1, "t":"e"}, {"h":0, "t":"e"}],[{"h":0, "t":"e"}, {"h":1, "t":"e"},{"h":0, "t":"e"},{"h":1, "t":"e"},{"h":0, "t":"e"}, {"h":1, "t":"e"}]], "medals": {"gold": 7, "silver": 9, "bronze": 11}}
        ],

        // ========================================================================
        // INITIALIZATION
        // ========================================================================

        init() {
            this.initThreeJS();
            this.initUI();
            this.loadLevelList();
            this.animate();
        },

        initThreeJS() {
            // Create scene
            this.scene = new THREE.Scene();
            this.scene.background = new THREE.Color(0x2c3e50);

            // Create renderer
            const canvas = document.getElementById('gameCanvas');
            const width = canvas.clientWidth || window.innerWidth;
            const height = canvas.clientHeight || window.innerHeight;

            // Create camera
            this.camera = new THREE.PerspectiveCamera(
                75,
                width / height,
                0.1,
                1000
            );
            this.camera.position.set(10, 8, 10);

            // Create renderer
            this.renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                antialias: true
            });
            this.renderer.setSize(width, height);
            this.renderer.shadowMap.enabled = true;
            this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Add controls
            this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
            this.controls.enableDamping = true;
            this.controls.dampingFactor = 0.05;

            // Add lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            this.scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            this.scene.add(directionalLight);

            // Create tile highlight indicator
            this.createTileHighlight();

            // Handle window resize
            window.addEventListener('resize', () => this.onWindowResize());
        },

        createTileHighlight() {
            // Create a ring/outline to highlight the current tile
            const ringGeometry = new THREE.RingGeometry(0.45, 0.55, 32);
            const ringMaterial = new THREE.MeshBasicMaterial({
                color: 0x00ff00,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.8
            });

            this.tileHighlight = new THREE.Mesh(ringGeometry, ringMaterial);
            this.tileHighlight.rotation.x = -Math.PI / 2; // Lay flat on ground
            this.tileHighlight.renderOrder = 998; // Render before bot
            this.scene.add(this.tileHighlight);
        },

        initUI() {
            // UI initialization (onclick handlers are already in HTML)
            console.log('UI initialized - program areas ready');

            // Mobile UI toggle
            const toggleBtn = document.getElementById('toggle-ui-mobile');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    const panel = document.getElementById('ui-panel');
                    if (panel.classList.contains('collapsed')) {
                        panel.classList.remove('collapsed');
                        toggleBtn.textContent = '‚ñº Hide Controls';
                    } else {
                        panel.classList.add('collapsed');
                        toggleBtn.textContent = '‚ñ∂ Show Controls';
                    }

                    // Resize canvas after toggle
                    setTimeout(() => {
                        if (this.renderer) {
                            this.onWindowResize();
                        }
                    }, 100);
                });
            }
        },

        // ========================================================================
        // LEVEL MANAGEMENT
        // ========================================================================

        loadLevelList() {
            const listContainer = document.getElementById('level-list');
            listContainer.innerHTML = '';

            this.levels.forEach((level, index) => {
                const button = document.createElement('button');
                button.className = 'level-button';
                button.textContent = `Level ${index + 1}`;
                button.onclick = () => this.loadLevel(index);

                // Check for saved medals
                const savedMedal = localStorage.getItem(`lightbot_level_${index}`);
                if (savedMedal === '4') button.classList.add('gold');
                else if (savedMedal === '3') button.classList.add('silver');
                else if (savedMedal === '2') button.classList.add('bronze');
                else if (savedMedal) button.classList.add('completed');

                listContainer.appendChild(button);
            });
        },

        loadLevel(levelIndex) {
            this.currentLevel = levelIndex;
            const level = this.levels[levelIndex];

            // Reset level data
            this.levelData = JSON.parse(JSON.stringify(level)); // Deep copy

            // Set bot starting position
            // Transform coordinates: index.html uses [col][flipped_row], new.html uses [row][col]
            const transformedPosition = {
                x: level.map.length - 1 - level.position.y,  // row = map.length - 1 - y
                y: level.position.x                          // col = x
            };
            this.bot.position = { ...transformedPosition };
            this.bot.direction = level.direction;
            this.bot.startPosition = { ...transformedPosition };
            this.bot.startDirection = level.direction;

            // Update levelData to use transformed position
            this.levelData.position = { ...transformedPosition };

            // Clear existing boxes
            this.boxes.forEach(box => this.scene.remove(box));
            this.boxes = [];

            // Create boxes for the level
            for (let x = 0; x < level.map.length; x++) {
                for (let y = 0; y < level.map[x].length; y++) {
                    const tile = level.map[x][y];
                    const mapX = x - level.map.length / 2;
                    const mapY = y - level.map[0].length / 2;
                    const box = this.createBox(mapX, mapY, tile.h, tile.t);
                    this.scene.add(box);
                    this.boxes.push(box);
                }
            }

            // Create or update bot
            if (!this.botMesh) {
                this.createBot();
            } else {
                this.updateBotPosition();
            }

            // Show tile highlight
            if (this.tileHighlight) {
                this.tileHighlight.visible = true;
            }

            // Clear programs
            this.clearPrograms();

            // Update UI
            document.getElementById('level-title').textContent = `Level ${levelIndex + 1}`;
            document.getElementById('level-info').textContent = `ü•á${level.medals.gold} ü•à${level.medals.silver} ü•â${level.medals.bronze}`;

            this.showScreen('game');
        },

        // ========================================================================
        // 3D RENDERING
        // ========================================================================

        createBox(x, y, height, type) {
            const boxGroup = new THREE.Group();

            if (type === 'e') {
                this.createElevatorBox(boxGroup, height);
            } else {
                this.createRegularBox(boxGroup, height, type);
            }

            boxGroup.position.set(x, 0, y);
            boxGroup.userData = { x, y, type, originalHeight: height };

            return boxGroup;
        },

        createRegularBox(group, height, type) {
            const boxHeight = height * 0.5;
            const geometry = new THREE.BoxGeometry(1, boxHeight, 1);

            let material;
            if (type === 'l') {
                material = new THREE.MeshLambertMaterial({
                    color: this.colors.lightBox.off,
                    transparent: true,
                    opacity: 0.9
                });
            } else {
                material = new THREE.MeshLambertMaterial({ color: this.colors.box.top });
            }

            const box = new THREE.Mesh(geometry, material);
            box.position.y = boxHeight / 2;
            box.castShadow = true;
            box.receiveShadow = true;

            const edges = new THREE.EdgesGeometry(geometry);
            const edgeMaterial = new THREE.LineBasicMaterial({
                color: this.colors.stroke,
                linewidth: 2
            });
            const wireframe = new THREE.LineSegments(edges, edgeMaterial);
            wireframe.position.y = boxHeight / 2;
            group.add(wireframe);
            group.add(box);
        },

        createElevatorBox(group, height) {
            const boxHeight = height * 0.5;
            const stickWidth = 0.1;

            // Base platform
            const baseGeometry = new THREE.BoxGeometry(1, 0.25, 1);
            const baseMaterial = new THREE.MeshLambertMaterial({ color: this.colors.elevator });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.position.y = 0.125;
            base.castShadow = true;
            group.add(base);

            // Vertical stick
            const stickGeometry = new THREE.BoxGeometry(stickWidth, boxHeight - 0.5, stickWidth);
            const stick = new THREE.Mesh(stickGeometry, baseMaterial);
            stick.position.y = boxHeight / 2;
            stick.castShadow = true;
            group.add(stick);

            // Top platform
            const top = new THREE.Mesh(baseGeometry, baseMaterial);
            top.position.y = boxHeight - 0.125;
            top.castShadow = true;
            group.add(top);
        },

        createBot() {
            console.log('Creating bot with sprite...');

            // Use HTML Image element to load sprite (works with file:// protocol)
            const image = new Image();
            image.crossOrigin = 'anonymous'; // Try to avoid CORS issues

            image.onload = () => {
                console.log('‚úì Sprite image loaded successfully!');

                // Create a canvas and draw the image to it (bypasses CORS restrictions)
                const canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 400;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(image, 0, 0);

                console.log('‚úì Canvas created with sprite image');

                // Create Three.js texture from the canvas
                const texture = new THREE.CanvasTexture(canvas);

                // Configure texture for pixel art (no filtering/blurring)
                texture.magFilter = THREE.NearestFilter;
                texture.minFilter = THREE.NearestFilter;

                // Sprite sheet is 640x400 pixels (8 cols √ó 4 rows)
                // Each sprite is 80√ó100 pixels
                texture.repeat.set(1/8, 1/4);
                texture.offset.set(0, 0.75); // Start at top-left (stand animation, SE direction)

                // Create sprite material
                const spriteMaterial = new THREE.SpriteMaterial({
                    map: texture,
                    transparent: true,
                    alphaTest: 0.5 // Don't render transparent pixels
                });

                // Create the sprite
                this.botMesh = new THREE.Sprite(spriteMaterial);

                // Scale sprite (maintain 80:100 aspect ratio, make it visible)
                this.botMesh.scale.set(2.0, 2.5, 1);

                // Render order to ensure it appears on top
                this.botMesh.renderOrder = 1000;

                // Disable depth test so sprite always shows
                spriteMaterial.depthTest = false;

                // Store texture reference for animations
                this.botTexture = texture;
                this.botCanvas = canvas;
                this.botCanvasCtx = ctx;
                this.botImage = image;

                // Position the bot
                this.updateBotPosition();

                // Add to scene
                this.scene.add(this.botMesh);

                console.log('‚úì Bot sprite added to scene');
                console.log('  Position:', this.botMesh.position);
                console.log('  Scale:', this.botMesh.scale);
            };

            image.onerror = (error) => {
                console.error('‚úó Failed to load sprite image:', error);
                console.log('‚ö† Using fallback 3D robot mesh');

                // Create fallback 3D robot
                this.createFallbackBot();
            };

            // Set the image source (same as original index.html)
            image.src = 'img/sprites.png';
        },

        createFallbackBot() {
            const botGroup = new THREE.Group();

            // Body
            const bodyGeometry = new THREE.BoxGeometry(0.6, 0.8, 0.4);
            const bodyMaterial = new THREE.MeshLambertMaterial({
                color: 0xff6b35,
                emissive: 0x331100
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 0.4;
            body.castShadow = true;
            botGroup.add(body);

            // Head
            const headGeometry = new THREE.BoxGeometry(0.5, 0.4, 0.4);
            const head = new THREE.Mesh(headGeometry, bodyMaterial);
            head.position.y = 1.0;
            head.castShadow = true;
            botGroup.add(head);

            // Eyes (glowing cyan)
            const eyeMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff });
            const eyeGeometry = new THREE.BoxGeometry(0.1, 0.1, 0.05);

            const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.15, 1.05, 0.2);
            botGroup.add(leftEye);

            const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.15, 1.05, 0.2);
            botGroup.add(rightEye);

            this.botMesh = botGroup;
            this.botTexture = null; // No texture for fallback
            this.updateBotPosition();
            this.scene.add(this.botMesh);

            console.log('‚úì Fallback bot created and added to scene');
        },

        updateBotPosition() {
            if (!this.botMesh || !this.levelData) return;

            const level = this.levelData;
            // Use same coordinate transformation as boxes (matching index.html)
            const mapX = this.bot.position.x - level.map.length / 2;
            const mapY = this.bot.position.y - level.map[0].length / 2;
            const currentTile = level.map[this.bot.position.x][this.bot.position.y];
            const height = currentTile.h * 0.5;

            // Position bot on top of tile
            // For sprites, position slightly higher for better visibility
            if (this.botTexture) {
                // Sprite bot - elevated position for visibility
                this.botMesh.position.set(mapX, height + 1.25, mapY);
            } else {
                // Mesh bot - standard position
                this.botMesh.position.set(mapX, height + 0.8, mapY);
            }

            // Update tile highlight position
            if (this.tileHighlight) {
                this.tileHighlight.position.set(mapX, height + 0.01, mapY);
            }

            // Update sprite animation if using sprite texture
            this.updateBotSprite();
        },

        updateBotSprite() {
            // Skip if no sprite texture (using fallback mesh)
            if (!this.botMesh || !this.botTexture) return;
            if (!this.botMesh.material || !this.botMesh.material.map) return;

            // Animation definitions (matching original game exactly)
            // sX is the X pixel position in sprite sheet, frames is number of animation frames
            const animations = {
                stand: { sX: 0, frames: 1, width: 80, height: 100 },
                walk: { sX: 80, frames: 3, width: 80, height: 100 },
                light: { sX: 480, frames: 2, width: 80, height: 100 },
                jumpUp: { sX: 320, frames: 1, width: 80, height: 100 },
                jumpDown: { sX: 400, frames: 1, width: 80, height: 100 }
            };

            const anim = animations[this.bot.currentAnimation] || animations.stand;

            // Sprite sheet dimensions
            const sheetWidth = 640;   // Total sheet width in pixels
            const sheetHeight = 400;  // Total sheet height in pixels

            // Direction mapping - match sprite rows to game directions
            // Game dirs: 0=SE, 1=NE, 2=NW, 3=SW
            // Sprite rows: adjusted for swapped x/y coordinate system
            // Mapping rotated 90¬∞ counter-clockwise: SE->0, NE->3, NW->2, SW->1
            const directionMap = [0, 3, 2, 1];
            const directionRow = directionMap[this.bot.direction];

            // Calculate current frame for animated sprites
            let currentFrame = 0;
            if (anim.frames > 1) {
                // Animate at ~5 FPS (200ms per frame)
                currentFrame = Math.floor(Date.now() / 200) % anim.frames;
            }

            // Calculate source X and Y in pixels (matching original canvas code)
            const srcX = anim.sX + (currentFrame * anim.width);
            const srcY = directionRow * anim.height;

            // Convert pixel coordinates to UV coordinates (0-1 range)
            // UV origin is bottom-left in Three.js, top-left in image
            const u = srcX / sheetWidth;
            const v = 1.0 - (srcY + anim.height) / sheetHeight;

            // Set the texture offset
            this.botTexture.offset.set(u, v);

            // Debug logging - shows current direction and sprite row
            if (this.bot.currentAnimation !== 'stand' || Date.now() % 1000 < 100) {
                console.log(`Bot: anim=${this.bot.currentAnimation}, gameDir=${this.bot.direction}, spriteRow=${directionRow}`);
            }
        },

        animate() {
            requestAnimationFrame(() => this.animate());

            this.controls.update();

            // Update bot sprite animation
            this.updateBotSprite();

            // Animate tile highlight (pulsing effect)
            if (this.tileHighlight) {
                const time = Date.now() * 0.001;
                this.tileHighlight.material.opacity = 0.5 + 0.3 * Math.sin(time * 3);
                this.tileHighlight.scale.set(
                    1 + 0.1 * Math.sin(time * 3),
                    1 + 0.1 * Math.sin(time * 3),
                    1
                );
            }

            // Animate light boxes (pulsing effect)
            this.boxes.forEach(box => {
                box.children.forEach(child => {
                    if (child.material && child.material.color.getHex() === this.colors.lightBox.off) {
                        const time = Date.now() * 0.001;
                        child.material.opacity = 0.7 + 0.3 * Math.sin(time * 2);
                    }
                });
            });

            this.renderer.render(this.scene, this.camera);
        },

        onWindowResize() {
            const canvas = document.getElementById('gameCanvas');
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;

            this.camera.aspect = width / height;
            this.camera.updateProjectionMatrix();
            this.renderer.setSize(width, height);
        },

        resetCamera() {
            this.camera.position.set(10, 8, 10);
            this.controls.reset();
        },

        toggleWireframe() {
            this.wireframeMode = !this.wireframeMode;
            this.boxes.forEach(box => {
                box.children.forEach(child => {
                    if (child.material) {
                        child.material.wireframe = this.wireframeMode;
                    }
                });
            });
        },

        // ========================================================================
        // PROGRAM EDITOR
        // ========================================================================

        focusProgram(programName) {
            console.log(`Focusing program: ${programName}`);
            this.focusedProgram = programName;

            document.querySelectorAll('.program-area').forEach(area => {
                area.classList.remove('focused');
            });

            const areaMap = {
                main: 'main-program',
                proc1: 'proc1-program',
                proc2: 'proc2-program'
            };

            const targetElement = document.getElementById(areaMap[programName]);
            if (targetElement) {
                targetElement.classList.add('focused');
                console.log(`‚úì Focused program area: ${programName}`);
            } else {
                console.error(`‚úó Could not find program area: ${areaMap[programName]}`);
            }
        },

        addInstruction(instructionType) {
            if (this.isExecuting) return;

            console.log(`Adding ${instructionType} to ${this.focusedProgram}`);
            const program = this.programs[this.focusedProgram];
            program.push(instructionType);
            this.updateProgramDisplay();
        },

        removeInstruction(programName, index) {
            if (this.isExecuting) return;

            this.programs[programName].splice(index, 1);
            this.updateProgramDisplay();
        },

        clearPrograms() {
            if (this.isExecuting) return;

            this.programs.main = [];
            this.programs.proc1 = [];
            this.programs.proc2 = [];
            this.updateProgramDisplay();
        },

        updateProgramDisplay() {
            const listMap = {
                main: 'main-list',
                proc1: 'proc1-list',
                proc2: 'proc2-list'
            };

            ['main', 'proc1', 'proc2'].forEach(programName => {
                const list = document.getElementById(listMap[programName]);
                list.innerHTML = '';

                this.programs[programName].forEach((inst, index) => {
                    const item = document.createElement('li');
                    item.className = 'instruction-item';
                    item.textContent = this.instructionDefs[inst].display;
                    item.onclick = () => this.removeInstruction(programName, index);
                    list.appendChild(item);
                });
            });
        },

        // ========================================================================
        // EXECUTION ENGINE
        // ========================================================================

        async runProgram(fast = false) {
            if (this.isExecuting) return;

            this.isExecuting = true;
            this.executionSpeed = fast ? 50 : 500;

            document.getElementById('execution-status').classList.add('active');
            document.getElementById('run-button').style.display = 'none';
            document.getElementById('fast-button').style.display = 'none';
            document.getElementById('stop-button').style.display = 'block';

            // Reset level state
            this.resetLevel();

            // Build execution queue
            const executionQueue = [...this.programs.main];

            try {
                await this.executeQueue(executionQueue);

                // Check if level is complete
                if (this.checkLevelComplete()) {
                    this.showLevelComplete();
                }
            } catch (error) {
                console.error('Execution error:', error);
            }

            this.stopExecution();
        },

        async executeQueue(queue, depth = 0) {
            if (depth > 100) {
                throw new Error('Maximum recursion depth exceeded');
            }

            for (let i = 0; i < queue.length && this.isExecuting; i++) {
                const instruction = queue[i];

                switch (instruction) {
                    case 'walk':
                        this.botWalk();
                        break;
                    case 'jump':
                        this.botJump();
                        break;
                    case 'light':
                        this.botLight();
                        break;
                    case 'turnLeft':
                        this.botTurnLeft();
                        break;
                    case 'turnRight':
                        this.botTurnRight();
                        break;
                    case 'proc1':
                        await this.executeQueue([...this.programs.proc1], depth + 1);
                        break;
                    case 'proc2':
                        await this.executeQueue([...this.programs.proc2], depth + 1);
                        break;
                }

                this.updateBotPosition();
                await this.delay(this.executionSpeed);
            }
        },

        stopExecution() {
            this.isExecuting = false;
            document.getElementById('execution-status').classList.remove('active');
            document.getElementById('run-button').style.display = 'inline-block';
            document.getElementById('fast-button').style.display = 'inline-block';
            document.getElementById('stop-button').style.display = 'none';
        },

        delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        },

        resetLevel() {
            // Reset bot
            this.bot.position = { ...this.bot.startPosition };
            this.bot.direction = this.bot.startDirection;
            this.bot.currentAnimation = 'stand';

            // Reset level data
            const originalLevel = this.levels[this.currentLevel];
            this.levelData = JSON.parse(JSON.stringify(originalLevel));

            // Transform position to match bot coordinate system
            this.levelData.position = { ...this.bot.startPosition };

            // Rebuild boxes
            this.boxes.forEach(box => this.scene.remove(box));
            this.boxes = [];

            for (let x = 0; x < this.levelData.map.length; x++) {
                for (let y = 0; y < this.levelData.map[x].length; y++) {
                    const tile = this.levelData.map[x][y];
                    const mapX = x - this.levelData.map.length / 2;
                    const mapY = y - this.levelData.map[0].length / 2;
                    const box = this.createBox(mapX, mapY, tile.h, tile.t);
                    this.scene.add(box);
                    this.boxes.push(box);
                }
            }

            this.updateBotPosition();

            // Update bot rotation for fallback mesh
            if (!this.botTexture && this.botMesh) {
                // Rotate fallback bot to face direction
                const rotations = [
                    Math.PI * 0.75,   // SE: 135¬∞
                    Math.PI * 0.25,   // NE: 45¬∞
                    -Math.PI * 0.25,  // NW: -45¬∞
                    -Math.PI * 0.75   // SW: -135¬∞
                ];
                this.botMesh.rotation.y = rotations[this.bot.direction];
            }
        },

        // ========================================================================
        // BOT ACTIONS
        // ========================================================================

        botWalk() {
            // Set walk animation
            this.bot.currentAnimation = 'walk';

            // Direction vectors matching index.html bot movement logic
            const directions = [
                { x: 0, y: -1 },  // SE: direction 0, moves y--
                { x: 1, y: 0 },   // NE: direction 1, moves x++
                { x: 0, y: 1 },   // NW: direction 2, moves y++
                { x: -1, y: 0 }   // SW: direction 3, moves x--
            ];

            const dir = directions[this.bot.direction];
            const newX = this.bot.position.x + dir.x;
            const newY = this.bot.position.y + dir.y;

            if (newX >= 0 && newX < this.levelData.map.length &&
                newY >= 0 && newY < this.levelData.map[0].length) {
                const currentHeight = this.levelData.map[this.bot.position.x][this.bot.position.y].h;
                const targetHeight = this.levelData.map[newX][newY].h;

                if (currentHeight === targetHeight) {
                    this.bot.position.x = newX;
                    this.bot.position.y = newY;
                }
            }

            // Return to stand after a delay
            setTimeout(() => {
                if (this.bot.currentAnimation === 'walk') {
                    this.bot.currentAnimation = 'stand';
                }
            }, 400);
        },

        botJump() {
            // Direction vectors matching index.html bot movement logic
            const directions = [
                { x: 0, y: -1 },  // SE: direction 0, moves y--
                { x: 1, y: 0 },   // NE: direction 1, moves x++
                { x: 0, y: 1 },   // NW: direction 2, moves y++
                { x: -1, y: 0 }   // SW: direction 3, moves x--
            ];

            const dir = directions[this.bot.direction];
            const newX = this.bot.position.x + dir.x;
            const newY = this.bot.position.y + dir.y;

            if (newX >= 0 && newX < this.levelData.map.length &&
                newY >= 0 && newY < this.levelData.map[0].length) {
                const currentHeight = this.levelData.map[this.bot.position.x][this.bot.position.y].h;
                const targetHeight = this.levelData.map[newX][newY].h;

                // Set appropriate jump animation
                if (targetHeight > currentHeight) {
                    this.bot.currentAnimation = 'jumpUp';
                } else if (targetHeight < currentHeight) {
                    this.bot.currentAnimation = 'jumpDown';
                } else {
                    this.bot.currentAnimation = 'walk';
                }

                // Can jump up 1 level or down any amount
                if (targetHeight - currentHeight === 1 || currentHeight > targetHeight) {
                    this.bot.position.x = newX;
                    this.bot.position.y = newY;
                }
            }

            // Return to stand after jump
            setTimeout(() => {
                if (this.bot.currentAnimation === 'jumpUp' || this.bot.currentAnimation === 'jumpDown') {
                    this.bot.currentAnimation = 'stand';
                }
            }, 400);
        },

        botLight() {
            // Set light animation
            this.bot.currentAnimation = 'light';

            const currentTile = this.levelData.map[this.bot.position.x][this.bot.position.y];

            if (currentTile.t === 'l') {
                // Toggle light box
                currentTile.lit = !currentTile.lit;
                const boxIndex = this.bot.position.x * this.levelData.map[0].length + this.bot.position.y;
                const box = this.boxes[boxIndex];

                if (box) {
                    box.children.forEach(child => {
                        if (child.material && child.material.color) {
                            const isOn = child.material.color.getHex() === this.colors.lightBox.on;
                            child.material.color.setHex(isOn ? this.colors.lightBox.off : this.colors.lightBox.on);
                        }
                    });
                }
            } else if (currentTile.t === 'e') {
                // Elevator logic
                const boxIndex = this.bot.position.x * this.levelData.map[0].length + this.bot.position.y;
                const box = this.boxes[boxIndex];

                if (box) {
                    const currentHeight = currentTile.h;
                    const newHeight = ((currentHeight + 2 - 1) % 6) + 1;
                    currentTile.h = newHeight;

                    // Rebuild elevator box
                    this.scene.remove(box);
                    const mapX = this.bot.position.x - this.levelData.map.length / 2;
                    const mapY = this.bot.position.y - this.levelData.map[0].length / 2;
                    const newBox = this.createBox(mapX, mapY, newHeight, 'e');
                    this.scene.add(newBox);
                    this.boxes[boxIndex] = newBox;
                }
            }

            // Return to stand after light action
            setTimeout(() => {
                if (this.bot.currentAnimation === 'light') {
                    this.bot.currentAnimation = 'stand';
                }
            }, 400);
        },

        botTurnLeft() {
            // Turn left = decrease direction (counter-clockwise in isometric view)
            this.bot.direction = (this.bot.direction - 1 + 4) % 4;

            // Update bot rotation for fallback mesh
            if (!this.botTexture && this.botMesh) {
                const rotations = [
                    Math.PI * 0.75,   // SE: 135¬∞
                    Math.PI * 0.25,   // NE: 45¬∞
                    -Math.PI * 0.25,  // NW: -45¬∞
                    -Math.PI * 0.75   // SW: -135¬∞
                ];
                this.botMesh.rotation.y = rotations[this.bot.direction];
            }
        },

        botTurnRight() {
            // Turn right = increase direction (clockwise in isometric view)
            this.bot.direction = (this.bot.direction + 1) % 4;

            // Update bot rotation for fallback mesh
            if (!this.botTexture && this.botMesh) {
                const rotations = [
                    Math.PI * 0.75,   // SE: 135¬∞
                    Math.PI * 0.25,   // NE: 45¬∞
                    -Math.PI * 0.25,  // NW: -45¬∞
                    -Math.PI * 0.75   // SW: -135¬∞
                ];
                this.botMesh.rotation.y = rotations[this.bot.direction];
            }
        },

        // ========================================================================
        // LEVEL COMPLETION
        // ========================================================================

        checkLevelComplete() {
            for (let x = 0; x < this.levelData.map.length; x++) {
                for (let y = 0; y < this.levelData.map[x].length; y++) {
                    const tile = this.levelData.map[x][y];
                    if (tile.t === 'l' && !tile.lit) {
                        return false;
                    }
                }
            }
            return true;
        },

        showLevelComplete() {
            const instructionCount = this.programs.main.length +
                                     this.programs.proc1.length +
                                     this.programs.proc2.length;

            const medals = this.levels[this.currentLevel].medals;
            let medal = 'none';
            let medalDisplay = '‚úÖ';

            if (instructionCount <= medals.gold) {
                medal = 'gold';
                medalDisplay = 'ü•á Gold Medal!';
            } else if (instructionCount <= medals.silver) {
                medal = 'silver';
                medalDisplay = 'ü•à Silver Medal!';
            } else if (instructionCount <= medals.bronze) {
                medal = 'bronze';
                medalDisplay = 'ü•â Bronze Medal!';
            } else {
                medalDisplay = '‚úÖ Level Complete!';
            }

            // Save medal
            const medalValue = { gold: 4, silver: 3, bronze: 2, none: 1 }[medal];
            const savedMedal = localStorage.getItem(`lightbot_level_${this.currentLevel}`);
            if (!savedMedal || parseInt(savedMedal) < medalValue) {
                localStorage.setItem(`lightbot_level_${this.currentLevel}`, medalValue.toString());
            }

            // Show dialog
            document.getElementById('medal-display').textContent = medalDisplay;
            document.getElementById('complete-message').innerHTML =
                `You used ${instructionCount} instructions.<br>` +
                `Target: ü•á${medals.gold} ü•à${medals.silver} ü•â${medals.bronze}`;
            document.getElementById('dialog-overlay').classList.add('active');
            document.getElementById('complete-dialog').classList.add('active');

            this.loadLevelList();
        },

        closeDialog() {
            document.getElementById('dialog-overlay').classList.remove('active');
            document.getElementById('complete-dialog').classList.remove('active');
        },

        nextLevel() {
            this.closeDialog();
            if (this.currentLevel < this.levels.length - 1) {
                this.loadLevel(this.currentLevel + 1);
            } else {
                this.showScreen('level-select');
            }
        },

        // ========================================================================
        // UI SCREENS
        // ========================================================================

        showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            const screenMap = {
                'welcome': 'welcome-screen',
                'help': 'help-screen',
                'level-select': 'level-select-screen',
                'game': 'game-screen'
            };

            document.getElementById(screenMap[screenName]).classList.add('active');

            // Hide tile highlight when not in game mode
            if (this.tileHighlight) {
                this.tileHighlight.visible = (screenName === 'game');
            }

            // Show map editor button only in game mode
            const mapEditorBtn = document.getElementById('toggle-map-editor');
            if (mapEditorBtn) {
                mapEditorBtn.style.display = (screenName === 'game') ? 'block' : 'none';
            }
        },

        // ========================================================================
        // MAP EDITOR
        // ========================================================================

        toggleMapEditor() {
            this.mapEditorMode = !this.mapEditorMode;

            const editorScreen = document.getElementById('map-editor-screen');
            const gameScreen = document.getElementById('game-screen');
            const toggleBtn = document.getElementById('toggle-map-editor');

            if (this.mapEditorMode) {
                // Save original level data for reset
                this.originalLevelData = JSON.parse(JSON.stringify(this.levelData));

                // Show map editor, hide game screen
                editorScreen.style.display = 'block';
                gameScreen.style.display = 'none';
                toggleBtn.textContent = 'üéÆ Back to Game';
                toggleBtn.style.background = '#4CAF50';

                // Render the map grid
                this.renderMapGrid();
            } else {
                // Hide map editor, show game screen
                editorScreen.style.display = 'none';
                gameScreen.style.display = 'block';
                toggleBtn.textContent = 'üó∫Ô∏è Map Editor';
                toggleBtn.style.background = '#FF9800';

                // Clear selection
                this.clearBlockSelection();
            }
        },

        renderMapGrid() {
            const gridContainer = document.getElementById('map-grid');
            gridContainer.innerHTML = '';

            if (!this.levelData || !this.levelData.map) {
                gridContainer.innerHTML = '<p>No map data available</p>';
                return;
            }

            const map = this.levelData.map;
            const rows = map.length;
            const cols = map[0] ? map[0].length : 0;

            // Create grid wrapper
            const gridWrapper = document.createElement('div');
            gridWrapper.style.display = 'inline-grid';
            gridWrapper.style.gridTemplateColumns = `repeat(${cols}, 40px)`;
            gridWrapper.style.gap = '2px';
            gridWrapper.style.background = '#333';
            gridWrapper.style.padding = '10px';
            gridWrapper.style.borderRadius = '5px';

            // Create cells
            for (let x = 0; x < rows; x++) {
                for (let y = 0; y < cols; y++) {
                    const block = map[x][y];
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;

                    // Show height as background darkness (higher = lighter)
                    const brightness = 50 + (block.h * 30);
                    cell.style.background = `rgb(${brightness}, ${brightness}, ${brightness})`;

                    // Show type icon
                    let icon = '';
                    if (block.t === 'l') icon = 'üí°';
                    else if (block.t === 'e') icon = 'üéöÔ∏è';
                    else icon = block.h; // Show height number

                    cell.innerHTML = `<div style="font-size: 14px; font-weight: bold;">${icon}</div>`;

                    // Highlight bot starting position
                    if (x === this.levelData.position.x && y === this.levelData.position.y) {
                        cell.classList.add('bot-position');
                        cell.style.border = '3px solid #4CAF50';
                    }

                    // Click handler
                    cell.addEventListener('click', () => this.selectBlock(x, y));

                    gridWrapper.appendChild(cell);
                }
            }

            gridContainer.appendChild(gridWrapper);
        },

        selectBlock(x, y) {
            console.log(`Selected block: (${x}, ${y})`);

            this.selectedBlock = { x, y };

            // Update visual selection
            document.querySelectorAll('.map-cell').forEach(cell => {
                cell.classList.remove('selected');
            });

            const selectedCell = document.querySelector(`.map-cell[data-x="${x}"][data-y="${y}"]`);
            if (selectedCell) {
                selectedCell.classList.add('selected');
            }

            // Show block editor panel
            const editor = document.getElementById('block-editor');
            const coords = document.getElementById('edit-coords');
            editor.style.display = 'block';
            coords.textContent = `${x}, ${y}`;

            // Highlight current values
            const block = this.levelData.map[x][y];

            // Highlight height button
            document.querySelectorAll('#block-editor button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Find and highlight active height
            const heightBtns = document.querySelectorAll('#block-editor button[onclick*="setBlockHeight"]');
            heightBtns.forEach(btn => {
                const height = parseInt(btn.getAttribute('onclick').match(/\d+/)[0]);
                if (height === block.h) {
                    btn.classList.add('active');
                }
            });

            // Find and highlight active type
            const typeBtns = document.querySelectorAll('#block-editor button[onclick*="setBlockType"]');
            typeBtns.forEach(btn => {
                const typeMatch = btn.getAttribute('onclick').match(/'([a-z])'/);
                if (typeMatch && typeMatch[1] === block.t) {
                    btn.classList.add('active');
                }
            });
        },

        setBlockHeight(height) {
            if (!this.selectedBlock) {
                console.log('No block selected');
                return;
            }

            const { x, y } = this.selectedBlock;
            console.log(`Setting block (${x}, ${y}) height to ${height}`);

            // Update model
            this.levelData.map[x][y].h = height;

            // Update 3D scene
            this.updateMapCell(x, y);

            // Re-render grid to show changes
            this.renderMapGrid();

            // Re-select the block to update editor
            this.selectBlock(x, y);
        },

        setBlockType(type) {
            if (!this.selectedBlock) {
                console.log('No block selected');
                return;
            }

            const { x, y } = this.selectedBlock;
            console.log(`Setting block (${x}, ${y}) type to ${type}`);

            // Update model
            this.levelData.map[x][y].t = type;

            // Update 3D scene
            this.updateMapCell(x, y);

            // Re-render grid to show changes
            this.renderMapGrid();

            // Re-select the block to update editor
            this.selectBlock(x, y);
        },

        updateMapCell(x, y) {
            // Calculate the box array index
            const boxIndex = x * this.levelData.map[0].length + y;
            const existingBox = this.boxes[boxIndex];

            if (existingBox) {
                this.scene.remove(existingBox);
            }

            // Create new box with updated data
            // Transform array indices to centered world coordinates
            const mapX = x - this.levelData.map.length / 2;
            const mapY = y - this.levelData.map[0].length / 2;
            const block = this.levelData.map[x][y];
            const box = this.createBox(mapX, mapY, block.h, block.t);

            // Store back in the same position in the boxes array
            this.boxes[boxIndex] = box;
            this.scene.add(box);
        },

        clearBlockSelection() {
            this.selectedBlock = null;

            document.querySelectorAll('.map-cell').forEach(cell => {
                cell.classList.remove('selected');
            });

            const editor = document.getElementById('block-editor');
            editor.style.display = 'none';
        },

        closeMapEditor() {
            console.log('Closing map editor');
            this.toggleMapEditor();
        },

        resetMapToOriginal() {
            if (!this.originalLevelData) {
                console.log('No original data to reset to');
                return;
            }

            console.log('Resetting map to original');

            // Restore original level data
            this.levelData = JSON.parse(JSON.stringify(this.originalLevelData));

            // Clear all boxes
            this.boxes.forEach(box => this.scene.remove(box));
            this.boxes = [];

            // Recreate map
            this.createMap();

            // Reset bot position
            this.bot.position = {...this.levelData.position};
            this.updateBotPosition();

            // Re-render grid
            this.renderMapGrid();

            // Clear selection
            this.clearBlockSelection();
        }
    };

    // Initialize game when page loads
    window.addEventListener('load', () => {
        game.init();

        // Setup map editor toggle button
        const mapEditorBtn = document.getElementById('toggle-map-editor');
        if (mapEditorBtn) {
            mapEditorBtn.addEventListener('click', () => game.toggleMapEditor());
            // Visibility will be controlled by showScreen()
        }
    });
    </script>
</body>
</html>
